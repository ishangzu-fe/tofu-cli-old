#! /usr/bin/env node

const program = require('commander');
const exec = require('child_process').exec;
const execSync = require('child_process').execSync;
const config = require('../config');
const log = require('../lib/log').log;
const logSuccess = require('../lib/log').logSuccess;
const ora = require('ora');

program
    .option('--cnpm', '使用cnpm来代替npm')
    .option('--yarn', '使用yarn来代替npm')
    .option('--npm', '使用npm来代替设置的工具')
    .parse(process.argv);

const execParallel = (commandArr) => {
    const spinner = new ora('正在升级i-tofu...').start();
    log();
    execSync(commandArr[0]);
    logSuccess('升级i-tofu成功');

    spinner.text = '正在升级tofu-cli...';
    let child = exec(commandArr[1], (error, stdout, stderr) => {
        if (error) {
            throw error;
            return;
        } else {
            log();
            logSuccess('升级tofu-cli成功');
            spinner.stop();
        }
    });
}

if (program.cnpm) {
    execParallel(['cnpm install i-tofu@latest', 'cnpm install -g tofu-cli@latest']);
} else if (program.yarn) {
    execParallel(['yarn add i-tofu@latest', 'yarn global add tofu-cli@latest']);
} else if (program.npm) {
    execParallel(['npm install i-tofu@latest', 'npm install -g tofu-cli@latest']);
} else {
    execParallel([config.tool + ' install i-tofu@latest', config.tool + ' install -g tofu-cli@latest']);
}
